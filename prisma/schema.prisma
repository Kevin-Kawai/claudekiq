// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  createdAt DateTime @default(now())
}

model Job {
  id          Int       @id @default(autoincrement())
  queue       String    @default("default")
  payload     String
  status      String    @default("pending") // scheduled, pending, processing, completed, failed
  priority    Int       @default(0)
  attempts    Int       @default(0)
  maxAttempts Int       @default(3)
  error       String?
  createdAt   DateTime  @default(now())
  processedAt DateTime?
  completedAt DateTime?

  // Scheduling fields
  scheduledFor   DateTime? // When to run this job (null = run immediately)
  cronExpression String?   // Cron expression for recurring jobs (e.g., "0 9 * * *")
  isRecurring    Boolean   @default(false)
  lastRunAt      DateTime? // Last time this recurring job was executed
  nextRunAt      DateTime? // Next scheduled run time for recurring jobs
  parentJobId    Int?      // For recurring jobs, links instances back to the parent definition

  // Conversation link (for ConversationMessageJob)
  conversationId Int?
  conversation   Conversation? @relation(fields: [conversationId], references: [id])

  @@index([queue, status, priority, createdAt])
  @@index([status, scheduledFor]) // For efficiently finding ready scheduled jobs
  @@index([isRecurring, nextRunAt]) // For efficiently finding recurring jobs to spawn
  @@index([conversationId])
}

model Workspace {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  path      String   // Base path to the git repository
  createdAt DateTime @default(now())

  // Relations
  conversations Conversation[]
  templates     ConversationTemplate[]

  @@index([name])
}

model Conversation {
  id          Int        @id @default(autoincrement())
  title       String?    // Optional title, can be auto-generated from first message
  sessionId   String?    // Claude session ID for resuming
  cwd         String?    // Working directory for the session (worktree path if using worktree)
  status      String     @default("active") // active, closed
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Workspace link
  workspaceId   Int?
  workspace     Workspace? @relation(fields: [workspaceId], references: [id])
  worktreePath  String?    // Path to the worktree if one was created
  worktreeBranch String?   // Branch name for the worktree

  // Claude SDK query options (JSON)
  queryOptions String?    // JSON string: { additionalDirectories?: string[], allowedTools?: string[] }

  // Relations
  messages      Message[]
  jobs          Job[]
  discordThread DiscordThreadMapping?

  @@index([status, updatedAt])
  @@index([workspaceId])
}

model Message {
  id             Int          @id @default(autoincrement())
  conversationId Int
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  role           String       // "user", "assistant", "system", "result"
  content        String       // JSON string of the message content
  jobId          Int?         // The job that processed/created this message
  createdAt      DateTime     @default(now())

  @@index([conversationId, createdAt])
}

model Toolset {
  id        Int      @id @default(autoincrement())
  name      String   @unique
  tools     String   // JSON array of tool names, e.g. ["Read", "Edit", "Glob", "Bash"]
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  templates ConversationTemplate[]

  @@index([isDefault])
}

model ConversationTemplate {
  id                    Int      @id @default(autoincrement())
  name                  String   @unique
  description           String?

  // Conversation settings
  title                 String?  // Template for conversation title
  workspaceId           Int?
  workspace             Workspace? @relation(fields: [workspaceId], references: [id])
  useWorktree           Boolean  @default(false)
  branchNamePattern     String?  // Pattern for branch name, e.g., "feature/{name}"

  // Claude SDK options
  toolsetId             Int?     // Reference to a saved toolset
  toolset               Toolset? @relation(fields: [toolsetId], references: [id])
  allowedTools          String?  // JSON array of tool names (used if no toolsetId)
  additionalDirectories String?  // JSON array of directory paths

  // Initial message template
  initialMessage        String?  // The prompt to start with
  cronExpression        String?  // For recurring initial messages

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([name])
}

model DiscordThreadMapping {
  id             Int          @id @default(autoincrement())
  threadId       String       @unique // Discord thread ID
  channelId      String       // Parent channel ID
  conversationId Int          @unique // One thread per conversation
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())

  @@index([conversationId])
}
